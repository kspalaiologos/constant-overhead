#!/bin/env BQN

fopen  â† "/usr/lib/libc.so.6" â€¢FFI "*"â€¿"fopen"â€¿"*u8"â€¿"*u8"
fclose â† "/usr/lib/libc.so.6" â€¢FFI "i32"â€¿"fclose"â€¿"*"
fgetc  â† "/usr/lib/libc.so.6" â€¢FFI "i32"â€¿"fgetc"â€¿"*"
fputc  â† "/usr/lib/libc.so.6" â€¢FFI "i32"â€¿"fputc"â€¿"i32"â€¿"*"
fflush â† "/usr/lib/libc.so.6" â€¢FFI "i32"â€¿"fflush"â€¿"*"

ctx â† 1
ct â† 256â€¿2â¥Š0

New â† {
    out â† ğ•©
    {
        x â† x1 â† 0
        x2 â† 4294967295
        p â† 2048
        Flush â‡ {ğ•©: 
            Fputc (âŒŠx1Ã·16777216)â€¿out 
            @
        }
        EncodeBit â‡ {
            xmid â† 4294967296|x1+(pÃ—âŒŠrangeÃ·4096)+âŒŠ(pÃ—4096|rangeâ†x2-x1)Ã·4096
            ct (1âŠ¸+ âŒ¾ (ctxâ€¿ğ•©âŠ¸âŠ‘))â†©
            ct âŒŠâˆ˜Ã·âŸœ2 âŒ¾ (ctxâŠ¸âŠ) âŸ (65534<ctxâ€¿ğ•©âŠ‘ct)â†©
            ctx 1âŸ(256â‰¤ctx +â†© ctx+ğ•©) â†©
            p â†© (4096Ã—1+ctxâ€¿1âŠ‘ct)âŒŠâˆ˜Ã·2+Â´ctxâŠct
            ğ•©â—¶{ğ•©:x1 â†© xmid+1}â€¿{ğ•©:x2 â†© xmid} @
            {ğ•©:
                Fputc (âŒŠx1Ã·16777216)â€¿out 
                x1 â†© 4294967296|x1Ã—256 
                x2 â†© 4294967296|255+x2Ã—256 
                @
            } â€¢_while_ {ğ•©:
                0â‰¡âŒŠÃ·âŸœ16777216 4294967296|âŠ‘ x1 32â€¢bit._xorâ—‹(â¥Š-âŸœ(4294967296Ã—â‰¥âŸœ2147483648)) x2
            } @
        }
    }
}

EncodeFile â† {
inâ€¿out:
    size â† â€¢file.Size in
    in_stream â† Fopen 0âˆ¾Â¨Ëœ @-Ëœinâ€¿"r"
    out_stream â† Fopen 0âˆ¾Â¨Ëœ @-Ëœoutâ€¿"w"
    {Fputc ğ•©â€¿out_stream}Â¨ âŒ½â¥Š32â€¿8â€¢bit._cast â¥Š-âŸœ(4294967296Ã—â‰¥âŸœ2147483648)size
    ac â† New out_stream
    c â† 0
    {ğ•©:ac.EncodeBitÂ¨âŒ½8â€¿1â€¢bit._castâ¥Š-âŸœ(256Ã—â‰¥âŸœ128)c} â€¢_while_ {ğ•©:Â¯1â‰¢câ†©Fgetc â¥Šin_stream} @
    ac.Flush @
    Fcloseâˆ˜â¥ŠÂ¨ in_streamâ€¿out_stream
}

EncodeFile â€¢args
