#!/bin/env BQN

fopen  â† "/usr/lib/libc.so.6" â€¢FFI "u64"â€¿"fopen"â€¿"*u8"â€¿"*u8"
fclose â† "/usr/lib/libc.so.6" â€¢FFI "i32"â€¿"fclose"â€¿"u64"
fgetc  â† "/usr/lib/libc.so.6" â€¢FFI "i32"â€¿"fgetc"â€¿"u64"
fputc  â† "/usr/lib/libc.so.6" â€¢FFI "i32"â€¿"fputc"â€¿"i32"â€¿"u64"
fflush â† "/usr/lib/libc.so.6" â€¢FFI "i32"â€¿"fflush"â€¿"u64"

High  â† âŒŠâˆ˜Ã·âŸœ16777216
Trunc â† 4294967296âŠ¸|
Xor   â† Truncâˆ˜âŠ‘ 32â€¢bit._xorâ—‹{â¥Šğ•©-(ğ•©â‰¥2147483648)Ã—4294967296}

ctx â† 1
ct â† 256â€¿2â¥Š0
Predict â† {
	ct (1âŠ¸+ âŒ¾ (ctxâ€¿ğ•©âŠ¸âŠ‘))â†©
	ct âŒŠâˆ˜Ã·âŸœ2 âŒ¾ (ctxâŠ¸âŠ) âŸ (65534<ctxâ€¿ğ•©âŠ‘ct)â†©
	ctx 1âŸ(256â‰¤ctx +â†© ctx+ğ•©) â†©
	(4096Ã—1+ctxâ€¿1âŠ‘ct)âŒŠâˆ˜Ã·2+Â´ctxâŠct
}

New â† {
	out â† ğ•©
	{
		x â† 0
		x1 â† 0
		x2 â† 4294967295
		p â† 2048
		Flush â‡ {ğ•©: Fputc (High x1)â€¿out â‹„@}
		Rescale â† {ğ•©:x1 â†© Trunc x1Ã—256 â‹„ x2 â†© Trunc 255+256Ã—x2 â‹„@}
		EncodeBit â‡ {
			xmid â† Trunc x1 + (pÃ—rangeâŒŠâˆ˜Ã·4096) + (pÃ—4096|rangeâ†x2-x1) âŒŠâˆ˜Ã· 4096
			p â†© Predict ğ•©
			ğ•©â—¶{ğ•©:x1 â†© xmid+1}â€¿{ğ•©:x2 â†© xmid} @
			Rescaleâˆ˜Flush â€¢_while_ {ğ•©:0â‰¡High x1 Xor x2} @
		}
	}
}

EncodeFile â† {
inâ€¿out:
	size â† â€¢file.Size in
	in_stream â† Fopen 0âˆ¾Â¨Ëœ @-Ëœ  inâ€¿"r"
	out_stream â† Fopen 0âˆ¾Â¨Ëœ @-Ëœ outâ€¿"w"
	{Fputc ğ•©â€¿out_stream}Â¨ âŒ½â¥Š32â€¿8 â€¢bit._cast â¥Šsize
	ac â† New out_stream
	c â† 0
	{ğ•©:ac.EncodeBitÂ¨ âŒ½8â€¿1â€¢bit._castâ¥Š{ğ•©-(ğ•©â‰¥128)Ã—256}c} â€¢_while_ {ğ•©:Â¯1â‰¢câ†©Fgetc â¥Šin_stream} @
	ac.Flush @
	Fcloseâˆ˜â¥ŠÂ¨ in_streamâ€¿out_stream
}

EncodeFile â€¢args
